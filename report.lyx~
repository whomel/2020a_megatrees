#LyX 2.1 created this file. For more info see http://www.lyx.org/
\lyxformat 474
\begin_document
\begin_header
\textclass article
\use_default_options true
\maintain_unincluded_children false
\language english
\language_package default
\inputencoding auto
\fontencoding global
\font_roman default
\font_sans default
\font_typewriter default
\font_math auto
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100
\font_tt_scale 100
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize a4paper
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\index Index
\shortcut idx
\color #008000
\end_index
\leftmargin 2.5cm
\topmargin 2.5cm
\rightmargin 2.5cm
\bottommargin 2.5cm
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\quotes_language english
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
Half-yearly WHO phylogenies
\end_layout

\begin_layout Standard
Each 6 months, phylogenies including the most representatives strains from
 circulating influenza are reported to WHO.
 This document details step-by-step all the procedure.
\end_layout

\begin_layout Subsubsection*
About baltic3 and libraries.
\end_layout

\begin_layout Standard
A few custom libraries have to be included to run baltic3 properly:
\end_layout

\begin_layout Standard

\family typewriter
sys.path.append("/home/miguel/apps/baltic3")
\end_layout

\begin_layout Standard

\family typewriter
sys.path.append("/home/miguel/tmp/who-2018b")
\end_layout

\begin_layout Standard

\family typewriter
sys.path.append("/home/miguel/apps/automata")
\family default

\begin_inset Newline newline
\end_inset


\begin_inset Newline newline
\end_inset

These repositories are available on github:
\end_layout

\begin_layout Itemize
baltic3 (
\begin_inset CommandInset href
LatexCommand href
target "https://github.com/Don86/baltic3"

\end_inset

)
\end_layout

\begin_layout Itemize
who-2018b (
\begin_inset CommandInset href
LatexCommand href
target "https://github.com/vjlab/who-2018b"

\end_inset

)
\end_layout

\begin_layout Itemize
automata (
\begin_inset CommandInset href
LatexCommand href
target "https://github.com/Don86/automata"

\end_inset

)
\end_layout

\begin_layout Standard
The repository `
\begin_inset CommandInset href
LatexCommand href
target "https://github.com/vjlab/who-2018a"

\end_inset

` contains another type of tree.
 Normally, we are using who-2018b as a template because it includes an example
 of each tree (H1, H3, Victoria and Yamagata).
 Last repository is who-2019b.
\end_layout

\begin_layout Subsubsection*
** Edition for last trees of 2019
\end_layout

\begin_layout Standard
Normally, WHO sends the alignment and the metadata tables.
 For the 2nd 2019 trees, we downloaded the samples directly from gisaid.
 The process was:
\end_layout

\begin_layout Standard
\align left
1.
 First, download H1N1, H3N2, Vic and Yam data from gisaid with the config
 attached.
 We included the passages, to select only one per each (*
\family typewriter
nodup files
\family default
).
 It's important to keep the passage selected per each sample since we will
 need it to include the metadata: 
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename gisaid/configuration_gisaid/IMG_20190911_153927321.jpg
	height 130bp
	rotateOrigin center

\end_inset

 
\begin_inset Graphics
	filename gisaid/configuration_gisaid/IMG_20190911_154022617.jpg
	height 130bp
	rotateOrigin center

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Gisaid config1
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename gisaid/configuration_gisaid/IMG_20190912_093251225.jpg
	height 130bp

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Gisaid config2
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
newpage
\end_layout

\end_inset


\end_layout

\begin_layout Standard
2.
 We download the set of references prepared by Noemi from Gisaid (Worksets)
 and merge the fastas.
 Select the correct portion of HA, ids to uppercase and align.
 Move the selected root-entry from each fasta to the first position and
 run 
\begin_inset CommandInset href
LatexCommand href
name "TREESUB"
target "https://github.com/tamuri/treesub"

\end_inset

.
\end_layout

\begin_layout Section
Receive and prepare the data
\end_layout

\begin_layout Standard

\shape italic
*In case we receive the alignments directly from WHO
\end_layout

\begin_layout Standard
Two files are received from WHO: A fasta file (normally aligned) and a metadata
 file.
 Because how the script works, the easiest way to run it is to mantain exactly
 the same format.
 It means, for the metadata, the columns have to be:
\end_layout

\begin_layout Standard

\family typewriter
desing
\backslash
tReference|Reference
\backslash
tMonth|Month
\backslash
tHA.titre.turkey|HA Titre (Turkey)
\backslash
t
\begin_inset Newline newline
\end_inset

vaccination|Vaccination Status
\backslash
tage.category|Age Category
\backslash
t
\begin_inset Newline newline
\end_inset

Mich.45e.FD|Fold Difference (egg)
\backslash
tMich.45c.FD|Fold Difference (cell)
\backslash
tCountry
\family default

\begin_inset Newline newline
\end_inset

If some are not available, the script has to be edited.
 Everything in the metadata table will be included in the phylogeny, so
 delete what you don' t need.
\end_layout

\begin_layout Subsection*
Check for missing metadata
\end_layout

\begin_layout Standard
We can use the script `
\family typewriter
checkIDred.py
\family default
` to check that all the samples from the fasta file are included in the
 metada table:
\end_layout

\begin_layout Standard
`
\family typewriter
python checkIDrec.py H1_fortree.csv 2018_pdmH1_Ref.fasta
\family default
`
\end_layout

\begin_layout Subsection*
Set the correct names for the samples
\end_layout

\begin_layout Standard
The first medatada file from 2019 contained two desig columns: one for the
 fasta record and another one for the desired name in the tree.
 If this is the case, we can use the script `
\family typewriter
replace_IDS.py
\family default
` to replace the IDs from the fasta file.
 
\end_layout

\begin_layout Standard
`
\family typewriter
python replace_IDS.py file.csv file.fasta new_fasta.fa
\family default
`
\end_layout

\begin_layout Standard
We need to extract the 2 first columns, containg the names, in a csv file
 (
\family typewriter
file.csv
\family default
) and use it as an input.
\end_layout

\begin_layout Section
Generate substitutions tree
\end_layout

\begin_layout Standard
Once the medatada is correct and the ID names from the fasta file are ready,
 we run treesub 
\begin_inset Newline newline
\end_inset

(
\family typewriter
https://github.com/tamuri/treesub
\family default
) .
 Two files of interest in the ouput: `
\family typewriter
substitutions.tree
\family default
` and `
\family typewriter
substitutions.tsv
\family default
`.
\end_layout

\begin_layout Section
Prepare the final tree
\end_layout

\begin_layout Standard
We can use the previous notebook as a reference.
 In this case, `
\family typewriter
Viz-H1_2019_1s-nameFix-country.ipynb
\family default
`.
\end_layout

\begin_layout Standard
Things to keep in mind:
\end_layout

\begin_layout Itemize
In theory, 
\family typewriter
btu.treesub_to_bt
\family default
 has to outputs: 1) subs2.tree and 2) The nonsyn information per each branch.
 This function doesn't work 100% properly (checked and indicated by Don)
 so we need to read this information from the `
\family typewriter
substitutions.tsv
\family default
`.
 In order to prepare the file to be run with the jupyter notebook, we need
 to run the script `
\family typewriter
build_subs.py
\family default
`: `
\family typewriter
python build_subs.py subsitutions.tsv subs.csv
\family default
` .
 It generates the required file `
\family typewriter
subs.csv
\family default
`.
\end_layout

\begin_layout Itemize
The metadata used to show the legends has to be defined in a json file `
\family typewriter
data/cdict_2019.json
\family default
`.
 The order is important.
\end_layout

\begin_layout Itemize
In case we need to add more bars indicating the subtypes, check `
\family typewriter
gtype_bars_dict
\family default
`.
\end_layout

\end_body
\end_document
